from pathlib import Path

from hydromt_sfincs import SfincsModel

from hydroflows.workflow.method_parameters import Parameters
from hydroflows.workflow.method import Method
from hydroflows._typing import OutputDirPath, FileDirPath

from sfincs_gfm.methods.utils import copy_sfincs_model, parse_local_wl_data, fetch_local_wind_data

class Input(Parameters):

    sfincs_inp: FileDirPath

    wl_file: Path

    wind_file: Path

class Output(Parameters):
    
    sfincs_out_inp: FileDirPath

class Params(Parameters):

    wl_offset: float = 0.0

    output_dir: OutputDirPath

    copy_model: bool = False

class UpdateForcing(Method):

    name: str = "update_forcing"

    def __init__(
            self,
            sfincs_inp: FileDirPath,
            wl_file: Path,
            wind_file: Path,
            output_dir: Path,
            **params
    ):
        
        self.params: Params = Params(
            output_dir=output_dir,
            **params
        )
        self.input: Input = Input(
            sfincs_inp=sfincs_inp,
            wl_file=wl_file,
            wind_file=wind_file,
        )

        if self.params.copy_model and not self.params.output_dir:
            raise ValueError("Unknown dest. folder for copy operation.")
        
        sfincs_out_inp = self.params.output_dir / "sfincs.inp"
        if not self.params.copy_model and not self.params.output_dir.is_relative_to(
            self.input.sfincs_inp.parent
        ):
            raise ValueError("Output directory must be relative to the input directory when not copying the model.")
        self.output: Output = Output(
            sfincs_out_inp=sfincs_out_inp
        )

    def _run(self):

        root = self.input.sfincs_inp.parent
        out_root = self.output.sfincs_out_inp.parent
        copy_model = self.params.copy_model
        
        if copy_model:
            copy_sfincs_model(src=root, dest=out_root)

        bzspd = parse_local_wl_data(self.input.wl_file)
        wnd = fetch_local_wind_data(self.input.wind_file)

        sf = SfincsModel(root=root, mode="r", write_gis=False)
        sf.setup_waterlevel_forcing(timeseries=bzspd, merge=False)
        sf.setup_wind_forcing(timeseries=wnd)

        sf.set_root(out_root, mode="w+")
        sf.write_forcing()

